# Localstack local developer environment

Docker and LocalStack resources to be created:

- [Localstack](https://www.localstack.cloud/)
- [OpenSearch](https://docs.localstack.cloud/aws/services/opensearch/) 
- [OpenSearch Dashboard](https://docs.opensearch.org/docs/latest/dashboards/)
- OpenSearch Domain:```case-document-search-domain```
- Opensearch Index:```case-documents```, [setup-opensearch.sh](./init-scripts/create-opensearch-resources.sh)
- AWS resources, [setup-aws-resources.sh](./init-scripts/create-aws-resources.sh)

## Pre-requisites

- [Docker](https://docs.docker.com/get-started/get-docker/)
- [Docker Desktop](https://docs.docker.com/desktop/)
- [LocalStack Desktop](https://docs.localstack.cloud/aws/capabilities/web-app/localstack-desktop/)
<<<<<<< HEAD
- **For VPN WSL users**: If you are running the local environment from behind a corporate VPN with SSL inspection, you must also set the following environment variables in your .bashrc to allow LocalStack to trust your custom certificates:
```
# Ensures LocalStack and its internal services trust the custom CA
export LOCALSTACK_REQUESTS_CA_BUNDLE="/home/your_user/custom_ca_bundle.pem"
export LOCALSTACK_HOST_MOUNTS="/home/your_user/custom_ca_bundle.pem:/etc/ssl/certs/custom_ca_bundle.pem"
```
This assumes you have already created the custom_ca_bundle.pem file as described in the main project README, CICA specific Windows WSL setup and confguration instructions.
=======
- Ensure yout `local-dev-environment/.env` file has the same valid AWS credentials see the `local-dev-environment/.env_template` file. 

>>>>>>> 4a1bf1a (feature(wip): add page image local stack creation)

## Setup

Navigate into the local-dev-environment folder 

```cd cica-review-case-documents-airflow/local-dev-environment```

and run

```docker compose up -d --force-recreate```

You should see 

```
:~/cica-review-case-documents-airflow/local-dev-environment$ docker compose up -d --force-recreate
[+] Running 5/5
 ✔ Network local-dev-environment_default  Created                                             
 ✔ Volume "local-dev-environment_data01"  Created                                         
 ✔ Container opensearch                  Started                                             
 ✔ Container localstack-main             Healthy                                     
 ✔ Container opensearch-dashboards       Started   
```

View the localstack logs

```docker  logs localstack-main -f```

Look for 

```
Waiting for OpenSearch domain to be created...
2025-07-09T13:38:52.761  INFO --- [et.reactor-0] localstack.request.aws     : AWS opensearch.DescribeDomain => 200
        "Processing": false,
OpenSearch domain created.
2025-07-09T13:38:54.510  INFO --- [et.reactor-0] localstack.request.aws     : AWS opensearch.DescribeDomain => 200
DOMAIN_ENDPOINT: case-document-search-domain.eu-west-2.opensearch.localhost.localstack.cloud:4566
Waiting for OpenSearch to be ready...
```
There may be a short delay whilst the domain spins up then you should see


```
OpenSearch is ready! Creating index 'case-documents'...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  1168  100    73  100  1095    174   2610 --:--:-- --:--:-- --:--:--  2794
{"acknowledged":true,"shards_acknowledged":true,"index":"case-documents"}LocalStack resources configuration completed.
Ready.

```

The environment is then ready to be used and the domain endpoint should be: 
```case-document-search-domain.eu-west-2.opensearch.localhost.localstack.cloud:4566```


## Docker Desktop 

If Docker Desktop has been installed you can view, pause, stop, run and view logs for the environment and the individual containers from within the Docker Desktop UI (recommended).

## Opensearch Dashboard

Navigate to http://127.0.0.1:5601/ to view the OpenSearch dashboard.

Navigate to [indices](http://127.0.0.1:5601/app/opensearch_index_management_dashboards#/indices?from=0&search=&showDataStreams=false&size=20&sortDirection=desc&sortField=index) to view the newly created index ```case-documents``` index.

Note you may need to index a document before creating an index pattern, to do so follow the instructions within the main [README](../README.md)

Create an [index pattern](https://docs.opensearch.org/latest/dashboards/management/index-patterns/) name it case-documents

you can start keyword searching read the [quickstart](https://docs.opensearch.org/latest/dashboards/quickstart/)


## Integration Helper

Within the integration_helper directory you will find a number of python scripts that can be used for local development testing.
These are largely redundant now and will most likely be removed in an upcoming commit. 

Use the main application [README](../README.md) for instructions on processing a document.

put_doc.py can be used to insert a document into the local opensearch db, it uses an embedding generated by the embedding_generator.py.
search_for_doc.py searches for the inserted document using the same embedding. 

TODO: add to a local integration test suite.

# Using the Hybrid Search Client (`search_client.py`)

This script allows you to perform hybrid (keyword + semantic) search queries against your local OpenSearch instance and export the results to Excel. You can choose for the keyword section to be either direct keyword or to use fuzzy

## Prerequisites

- Ensure your OpenSearch instance is running and accessible.
- Ensure your `.env` file in the project root contains valid AWS credentials and OpenSearch connection details (see main README for details).
- Ensure your `local-dev-environment/.env` file has the same valid AWS credentials see the `local-dev-environment/.env_template` file. 

## Running the Search Client

From the project root, run:

```sh
python local-dev-environment/search_client.py
```

## Configuration

You can adjust search parameters (e.g., search term, number of results, score filter) and enable/disable fuzzy matching at the top of `search_client.py`.

Results will be written to an Excel file in the `output/hybrid-test-results/<date>/` directory.
