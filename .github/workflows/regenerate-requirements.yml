name: Regenerate requirements.txt

permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
    paths:
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/regenerate-requirements.yml"
  workflow_dispatch:

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Regenerate requirements.txt
        run: uv pip compile --generate-hashes --output-file requirements.txt pyproject.toml

      - name: Check if requirements.txt is up to date
        id: check_requirements
        run: |
          git diff --exit-code requirements.txt || (
            echo "‚ùå requirements.txt is not up to date with pyproject.toml and uv.lock."
            echo "Please run:"
            echo "  uv pip compile --generate-hashes --output-file requirements.txt pyproject.toml"
            echo "and commit the result."
            exit 1
          )
